<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />

    <style>
        .chatbox {
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 1em;
            background-color: #f8f9fa;
        }

        .chat-header {
            font-size: 1.5rem;
            font-weight: bold;
        }

        #online_users {
            list-style: none;
            padding: 0;
        }

        #online_users li {
            background: #e9ecef;
            margin-bottom: 0.5em;
            padding: 0.5em;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <header class="text-center mb-4">
            <h1 class="display-4 fw-bold">Welcome to <span class="text-primary">GoBanter</span></h1>
            <p class="text-muted fs-5">Connect and communicate with ease</p>
            <hr class="mt-4">
        </header>
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <div class="chat-header">Chat</div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" id="username" class="form-control" placeholder="Enter your username">
                        </div>
                        <div class="mb-3">
                            <label for="message" class="form-label">Message</label>
                            <input type="text" id="message" class="form-control" placeholder="Type your message">
                        </div>
                        <div class="d-flex justify-content-between">
                            <button id="sendButton" class="btn btn-primary">Send Message</button>
                            <div id="status"></div>
                        </div>
                        <div id="output" class="chatbox mt-3"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-header bg-secondary text-white">
                        <div class="chat-header">Who's Online</div>
                    </div>
                    <div class="card-body">
                        <ul id="online_users"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
        integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>

    <script src="/assets/reconnecting-websocket.min.js"></script>

    <script>
        let socket = null;
    
        $(document).ready(function () {
            const offline = `<span class="badge bg-danger">Not connected</span>`;
            const online = `<span class="badge bg-success">Connected</span>`;
    
            const $statusDiv = $("#status");
            const $output = $("#output");
            const $userField = $("#username");
            const $messageField = $("#message");
            const $onlineUsers = $("#online_users");
    
            // Reconnecting WebSocket Initialization
            socket = new ReconnectingWebSocket("ws://localhost:8080/ws", null, { debug: true, reconnectInterval: 3000 });
    
            // WebSocket Events
            socket.onopen = function () {
                console.log("connected!!");
                $statusDiv.html(online);
            };
    
            socket.onclose = function () {
                console.log("connection closed!");
                $statusDiv.html(offline);
            };
    
            socket.onerror = function () {
                console.log("there was an error");
                $statusDiv.html(offline);
            };
    
            socket.onmessage = function (msg) {
                const data = JSON.parse(msg.data);
                console.log("Action:", data.action);
    
                switch (data.action) {
                    case "list_users":
                        $onlineUsers.empty();
                        if (data.connected_users.length > 0) {
                            $.each(data.connected_users, function (index, user) {
                                $onlineUsers.append(`<li class="list-group-item">${user}</li>`);
                            });
                        }
                        break;
    
                    case "broadcast":
                        $output.append(`<div>${data.message}</div>`);
                        $output.scrollTop($output.prop("scrollHeight"));
                        break;
                }
            };
    
            // Username Field Change
            $userField.on("change", function () {
                const jsonData = {
                    action: "username",
                    username: $(this).val()
                };
                console.log(jsonData);
                socket.send(JSON.stringify(jsonData));
            });
    
            // Message Field Enter Key
            $messageField.on("keydown", function (event) {
                if (event.key === "Enter") {
                    if (!socket || socket.readyState !== WebSocket.OPEN) {
                        alert("No connection");
                        return false;
                    }
    
                    if (!$userField.val() || !$messageField.val()) {
                        alert("Enter username and message!");
                        return false;
                    } else {
                        sendMessage();
                    }
    
                    event.preventDefault();
                }
            });
    
            // Send Button Click
            $("#sendButton").on("click", function () {
                if (!$userField.val() || !$messageField.val()) {
                    alert("Enter username and message!");
                    return false;
                } else {
                    sendMessage();
                }
            });
    
            // WebSocket Disconnect on Page Unload
            $(window).on("beforeunload", function () {
                console.log("leaving ;(");
                if (socket && socket.readyState === WebSocket.OPEN) {
                    const jsonData = { action: "left" };
                    socket.send(JSON.stringify(jsonData));
                }
            });
    
            // Function to Send Message
            function sendMessage() {
                const jsonData = {
                    action: "broadcast",
                    username: $userField.val(),
                    message: $messageField.val()
                };
                socket.send(JSON.stringify(jsonData));
                $messageField.val("");
            }
        });
    </script>
    

</body>

</html>